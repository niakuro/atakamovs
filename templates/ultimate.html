<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>è¦³æ¸¬å›VS ULTIMATE Ver 3.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root { 
            --gold: #ffdf00; 
            --blue: #3498db; 
            --red: #e74c3c; 
            --purple: #9b59b6;
            --green: #2ecc71;
            --orange: #e67e22;
            --cyan: #1abc9c;
            --dark: #1a1a1a; 
        }
        body { margin: 0; color: white; font-family: 'Helvetica', sans-serif; background: #000; overflow: hidden; }
        
        /* å®Ÿå†™èƒŒæ™¯ */
        .master-bg { 
            position: fixed; inset: 0; z-index: -10; 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: opacity 1s ease;
        }
        
        /* èƒŒæ™¯ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆè¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ï¼‰ */
        .master-bg::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(1px);
        }
        
        /* ã»ã“ã‚Šã‚„å…‰ã®ç²’å­ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .master-bg::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(255, 255, 200, 0.15) 0%, transparent 30%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 200, 0.1) 0%, transparent 25%),
                radial-gradient(circle at 40% 80%, rgba(255, 255, 255, 0.08) 0%, transparent 20%);
            animation: dustFloat 25s ease infinite;
            z-index: 1;
        }
        
        @keyframes dustFloat {
            0%, 100% { transform: translate(0, 0); opacity: 0.6; }
            25% { transform: translate(15px, -15px); opacity: 0.8; }
            50% { transform: translate(-10px, 15px); opacity: 0.5; }
            75% { transform: translate(20px, 10px); opacity: 0.7; }
        }
        
        /* ã‚«ãƒ¼ãƒ‰åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« - ã‚ˆã‚Šã‚«ãƒ©ãƒ•ãƒ«ã« */
        .card { 
            width: 95px; height: 145px; 
            background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
            border-radius: 8px; color: #222; padding: 6px; 
            position: relative; cursor: pointer; font-size: 10px; 
            border: 2px solid #999; box-sizing: border-box; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .card:hover { 
            transform: translateY(-8px) scale(1.05); 
            border-color: var(--gold); 
            box-shadow: 0 10px 30px rgba(255,223,0,0.4), 0 0 20px rgba(255,223,0,0.2);
        }
        .card.MACHINE { 
            border-top: 6px solid var(--blue); 
            background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
        }
        .card.SPELL { 
            border-top: 6px solid var(--red); 
            background: linear-gradient(135deg, #ffffff 0%, #ffebee 100%);
        }
        .card.GOAL { 
            border: 3px solid var(--gold); 
            background: linear-gradient(135deg, #fff9c4 0%, #ffeb3b 100%);
            box-shadow: 0 0 20px rgba(255, 223, 0, 0.5);
        }
        
        /* ã‚«ãƒ¼ãƒ‰å†…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .cost { position: absolute; top: -8px; left: -8px; background: var(--gold); border-radius: 50%; width: 24px; height: 24px; text-align: center; font-weight: bold; border: 1.5px solid #000; line-height: 24px; z-index: 2; color: #000; }
        .upkeep { position: absolute; bottom: 5px; left: 5px; color: var(--red); font-weight: bold; font-size: 9px; }
        .power { position: absolute; bottom: 3px; right: 5px; font-size: 18px; font-weight: 900; color: var(--blue); }
        
        /* ã‚«ãƒ¼ãƒ‰åã¨åŠ¹æœã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .card b { margin-left: 14px; display: inline-block; font-size: 11px; margin-bottom: 2px;}
        .card small { display: block; line-height: 1.2; font-size: 9px; color: #444; height: 95px; overflow: hidden; }

        /* ãƒ‡ãƒƒã‚­æšæ•°ãƒãƒƒã‚¸ */
        .deck-badge { position: absolute; top: 0px; right: 0px; background: #000; color: #fff; padding: 2px 6px; border-radius: 0 8px 0 8px; font-weight: bold; font-size: 12px; border: 1px solid var(--gold); z-index: 5; }
        
        /* ãƒ‡ãƒƒã‚­ã«å…¥ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’å…‰ã‚‰ã›ã‚‹ */
        .card.in-deck {
            border: 2px solid var(--gold);
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.6), 0 0 40px rgba(241, 196, 15, 0.3);
            animation: deckGlow 2s ease-in-out infinite;
            transform: translateY(-2px);
        }
        
        @keyframes deckGlow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(241, 196, 15, 0.6), 0 0 40px rgba(241, 196, 15, 0.3);
            }
            50% { 
                box-shadow: 0 0 30px rgba(241, 196, 15, 0.8), 0 0 60px rgba(241, 196, 15, 0.5);
            }
        }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        #screen-battle { display: none; grid-template-columns: 1fr 300px; height: 100vh; }
        .sidebar { 
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
            border-left: 3px solid var(--cyan); 
            padding: 20px; display: flex; flex-direction: column; gap: 10px;
            box-shadow: -5px 0 20px rgba(26, 188, 156, 0.3);
        }
        .field { 
            display: flex; justify-content: center; gap: 10px; 
            min-height: 170px; 
            border-bottom: 2px solid rgba(52, 152, 219, 0.5); 
            align-items: center;
            background: linear-gradient(90deg, 
                rgba(52, 152, 219, 0.05) 0%, 
                rgba(155, 89, 182, 0.05) 50%, 
                rgba(52, 152, 219, 0.05) 100%
            );
            padding: 10px 0;
        }
        .log { 
            flex-grow: 1; overflow-y: auto; 
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e);
            padding: 10px; font-size: 11px; 
            color: #0ff; 
            border: 2px solid var(--cyan); 
            font-family: monospace;
            box-shadow: inset 0 0 20px rgba(26, 188, 156, 0.2);
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ãƒ«ãƒ¼ãƒ« */
        #rules-box { 
            background: linear-gradient(135deg, rgba(20, 30, 48, 0.95), rgba(30, 20, 45, 0.95));
            backdrop-filter: blur(10px);
            padding: 20px; 
            border-radius: 15px; 
            margin-top: 20px; 
            font-size: 13px; 
            line-height: 1.8; 
            max-width: 650px;
            border: 2px solid rgba(52, 152, 219, 0.6);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.7), 0 0 20px rgba(52, 152, 219, 0.3);
        }
        #rules-box h3 {
            color: var(--gold);
            text-shadow: 0 0 15px rgba(241, 196, 15, 0.6);
            border-bottom: 2px solid rgba(241, 196, 15, 0.3);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .rule-tag { 
            color: var(--cyan); 
            font-weight: bold; 
            margin-right: 5px;
            text-shadow: 0 0 10px rgba(26, 188, 156, 0.8);
        }

        /* ãƒœã‚¿ãƒ³ - ã‚ˆã‚Šã‚«ãƒ©ãƒ•ãƒ«ã« */
        .btn { 
            padding: 12px 24px; border: none; border-radius: 8px; 
            font-weight: bold; cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn-gold { 
            background: linear-gradient(135deg, var(--gold) 0%, #ffa500 100%);
            color: #000;
            box-shadow: 0 4px 15px rgba(255, 223, 0, 0.4);
        }
        .btn-gold:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 223, 0, 0.6);
        }

        /* ã‚¿ãƒ¼ãƒ³æ¼”å‡ºã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #turn-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.95) 100%);
            display: none; justify-content: center; align-items: center;
            z-index: 1000; pointer-events: none;
        }
        #turn-overlay-text {
            font-size: 80px; font-weight: 900; 
            background: linear-gradient(135deg, var(--gold), var(--orange), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            border: 5px solid var(--gold); 
            padding: 20px 60px; 
            background-color: rgba(34, 34, 34, 0.9);
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(255, 223, 0, 0.6), inset 0 0 40px rgba(255, 223, 0, 0.2);
            animation: turnPulse 0.5s ease-in-out;
        }
        
        @keyframes turnPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ãƒªã‚¶ãƒ«ãƒˆç”»é¢ */
        #result-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.98) 100%);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000;
        }
        #result-title { 
            font-size: 60px; font-weight: bold; margin-bottom: 30px;
            text-shadow: 0 0 30px currentColor;
            animation: resultGlow 2s ease-in-out infinite;
        }
        
        @keyframes resultGlow {
            0%, 100% { text-shadow: 0 0 20px currentColor; }
            50% { text-shadow: 0 0 40px currentColor, 0 0 60px currentColor; }
        }
        
        /* é¸æŠãƒ¢ãƒ¼ãƒ‰ */
        .card-selectable { 
            border: 3px solid var(--gold) !important; 
            animation: pulseSelect 1s infinite;
            box-shadow: 0 0 30px rgba(255, 223, 0, 0.6) !important;
        }
        @keyframes pulseSelect {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(255, 223, 0, 0.6);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 40px rgba(255, 223, 0, 0.9);
                transform: scale(1.05);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="master-bg"></div>

    <div id="turn-overlay"><div id="turn-overlay-text"></div></div>

    <div id="result-modal">
        <div id="result-title"></div>
        <button class="btn btn-gold" onclick="backToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
    </div>

    <div id="screen-title" style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
        <h1 style="color:var(--gold); font-size:64px; text-shadow: 0 0 20px var(--gold); margin:0;">è¦³æ¸¬å›VS ULTIMATE</h1>
        <p style="color:#888; letter-spacing: 5px;">VER 4.1</p>
        
        <div id="rules-box">
            <h3 style="margin-top:0;">ç¾å ´ç›£ç£ã®å¿ƒå¾—ï¼ˆãƒ«ãƒ¼ãƒ«èª¬æ˜ï¼‰</h3>
            <div style="text-align:left;">
                <p><span class="rule-tag">â—APã‚·ã‚¹ãƒ†ãƒ :</span> æ¯ã‚¿ãƒ¼ãƒ³æœ€å¤§APãŒ1å¢—åŠ ï¼ˆæœ€å¤§10ï¼‰ã€‚ç¶­æŒè²»ãŒæœ€å¤§APã‹ã‚‰å¼•ã‹ã‚ŒãŸåˆ†ãŒä½¿ç”¨å¯èƒ½APã«ãªã‚‹ã€‚</p>
                <p><span class="rule-tag">â—å‹åˆ©æ¡ä»¶:</span> è¨ˆæ¸¬ã‚¹ã‚³ã‚¢ã‚’æºœã‚ã€ã€Œå‹åˆ©ã‚«ãƒ¼ãƒ‰ã€ï¼ˆ10ç‚¹ or 30ç‚¹ï¼‰ã‚’ä½¿ç”¨ã›ã‚ˆï¼</p>
                <p><span class="rule-tag">â—ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—:</span> MACHINEï¼ˆæ©Ÿæï¼‰ã€STAFFï¼ˆç¤¾å“¡ï¼‰ã€SPELLï¼ˆæ¸¬é‡ä½œæ¥­ï¼‰ã®3ç¨®é¡ã€‚å…¨55ç¨®ã®ã‚«ãƒ¼ãƒ‰åŠ¹æœã‚’é§†ä½¿ã›ã‚ˆï¼</p>
                <p><span class="rule-tag">â—å¤©å€™ã‚·ã‚¹ãƒ†ãƒ :</span> è±ªé›¨ï¼ˆã‚¹ãƒšãƒ«ç¦æ­¢ï¼‰ã€æ¿ƒéœ§ï¼ˆè¨ˆæ¸¬å€¤åŠæ¸›ï¼‰ã€æ™´å¤©ã€‚ãƒ‰ãƒ­ãƒ¼ãƒ³ã¯éœ§ã«å¼·ã„ã€‚</p>
                <p><span class="rule-tag">â—é€²åŒ–ã‚·ã‚¹ãƒ†ãƒ :</span> ä¸‹ä½æ©Ÿç¨®ãŒå ´ã«ã„ã‚Œã°ã€ä¸Šä½æ©Ÿç¨®ã‚’ã‚³ã‚¹ãƒˆ1ã§é‡ã­ã¦å‡ºã›ã‚‹ï¼ï¼ˆGPSâ†’RTK-GPSã€TSâ†’ãƒˆãƒ¼ã‚¿ãƒ«ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³â†’ãƒˆãƒ¼ã‚¿ãƒ«ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ULTIMATEï¼‰</p>
                <p><span class="rule-tag">â—ç‰¹æ®ŠçŠ¶æ…‹:</span> frozenï¼ˆå‡çµï¼‰ï¼šæŒ‡å®šã‚¿ãƒ¼ãƒ³æ•°ã®é–“ã€æ”»æ’ƒãƒ»åŠ¹æœãƒ»ç¶­æŒè²»ãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹ã€‚ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«1ãšã¤æ¸›å°‘ã€‚</p>
                <p><span class="rule-tag">â—é¸æŠã‚·ã‚¹ãƒ†ãƒ :</span> Trainingï¼ˆç ”ä¿®ï¼‰ã€Lostï¼ˆè¿·å­ï¼‰ã€Bushï¼ˆè—ªæ¼•ãï¼‰ã€Boundaryï¼ˆå¢ƒç•ŒçŸ³ï¼‰ãªã©ã¯å¯¾è±¡ã‚«ãƒ¼ãƒ‰ãƒ»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ã¦åŠ¹æœç™ºå‹•ã€‚</p>
                <p><span class="rule-tag">â—RushåŠ¹æœ:</span> ã‚¿ã‚°"Rush"æŒã¡ã®ã‚«ãƒ¼ãƒ‰ã¯ç›¸æ‰‹ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«ç ´å£Šã•ã‚Œã‚‹çŸ­æœŸæˆ¦åŠ›ã€‚</p>
                <p><span class="rule-tag">â—æˆ¦ç•¥ã®ã‚³ãƒ„:</span> åºç›¤ã¯å®‰ä¾¡ãªç¤¾å“¡ãƒ»æ©Ÿæã§å±•é–‹ã€ä¸­ç›¤ã§è¨ˆæ¸¬å€¤ã‚’ç¨¼ãã€çµ‚ç›¤ã«å‹åˆ©ã‚«ãƒ¼ãƒ‰ã§æ±ºç€ï¼ç¶­æŒè²»ç®¡ç†ãŒå‹æ•—ã‚’åˆ†ã‘ã‚‹ã€‚</p>
            </div>
        </div>

        <div id="room-section" style="margin-top:40px; background:rgba(20, 30, 48, 0.9); padding:25px; border-radius:15px; max-width:500px; border:2px solid rgba(241, 196, 15, 0.4);">
            <h3 style="color:var(--gold); margin-top:0;">ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰</h3>
            
            <!-- CPUæˆ¦ãƒœã‚¿ãƒ³ -->
            <div style="margin-bottom:25px;">
                <button onclick="startCPUGame()" class="btn" style="background:linear-gradient(135deg, #e67e22, #d35400); color:#fff; font-size:20px; width:100%; padding:15px;">ğŸ¤– CPUæˆ¦ï¼ˆç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼‰</button>
            </div>
            
            <div style="border-top:2px solid rgba(241, 196, 15, 0.2); padding-top:20px;">
                <h4 style="color:var(--cyan); margin-top:0;">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</h4>
                <div style="display:flex; gap:15px; margin-bottom:20px;">
                    <button onclick="createRoom()" class="btn" style="background:var(--green); color:#fff; font-size:18px; flex:1;">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
                </div>
                <div style="display:flex; gap:10px;">
                    <input id="room-input" type="text" placeholder="4æ¡ã®ãƒ«ãƒ¼ãƒ ç•ªå·" maxlength="4" style="flex:1; padding:12px; font-size:16px; border-radius:8px; border:2px solid #444; background:#222; color:#fff; text-align:center;">
                    <button onclick="joinRoomByInput()" class="btn" style="background:var(--cyan); color:#fff; font-size:18px;">å‚åŠ </button>
                </div>
                <div id="room-status" style="margin-top:15px; text-align:center; color:var(--gold); font-size:14px; min-height:24px;"></div>
            </div>
        </div>
    </div>

    <div id="screen-waiting" style="display:none; height:100vh; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
        <h1 style="color:var(--gold); font-size:48px; text-shadow: 0 0 20px var(--gold); margin:0;">å‚åŠ è€…å¾…æ©Ÿä¸­...</h1>
        <div style="margin-top:30px; background:rgba(20, 30, 48, 0.9); padding:30px; border-radius:15px; border:2px solid rgba(241, 196, 15, 0.4);">
            <p style="font-size:24px; color:#fff;">ãƒ«ãƒ¼ãƒ ç•ªå·</p>
            <p id="waiting-room-number" style="font-size:64px; color:var(--gold); font-weight:bold; letter-spacing:10px; margin:20px 0;">----</p>
            <p style="font-size:18px; color:#aaa;">ã“ã®ç•ªå·ã‚’ç›¸æ‰‹ã«ä¼ãˆã¦ãã ã•ã„</p>
            <div style="margin-top:30px; padding:20px; background:rgba(52, 152, 219, 0.1); border-radius:10px; border:1px solid rgba(52, 152, 219, 0.3);">
                <p style="color:var(--cyan); font-size:16px; margin:5px 0;">ã‚ãªãŸã¯ <span style="font-weight:bold; font-size:20px;">P1: å·¥äº‹éƒ¨é•·</span> ã§ã™</p>
            </div>
        </div>
        <div class="loading-spinner" style="margin-top:40px;">
            <div style="width:60px; height:60px; border:6px solid rgba(241, 196, 15, 0.2); border-top:6px solid var(--gold); border-radius:50%; animation:spin 1s linear infinite;"></div>
        </div>
    </div>

    <div id="screen-deck" style="display:none; padding:20px; height:100vh; box-sizing:border-box;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="color:var(--gold); margin:0;">ãƒ‡ãƒƒã‚­ç·¨æˆ (<span id="deck-count">0</span>/40)</h2>
            <div style="display:flex; gap:15px;">
                <button onclick="loadDeck('TRAINING')" class="btn" style="background:#333; color:#fff;">ç¤¾å“¡è‚²æˆãƒ‡ãƒƒã‚­</button>
                <button onclick="loadDeck('SURVEY')" class="btn" style="background:#333; color:#fff;">æ¸¬é‡æ©Ÿæ¢°ãƒ‡ãƒƒã‚­</button>
                <button onclick="loadDeck('CONSTRUCTION')" class="btn" style="background:#333; color:#fff;">é‡æ©ŸåœŸæœ¨ãƒ‡ãƒƒã‚­</button>
                <button onclick="submitDeck()" class="btn btn-gold">ç¾å ´ã¸å‡ºæ’ƒï¼</button>
            </div>
        </div>
        <div id="deck-grid" style="display:grid; grid-template-columns:repeat(9, 1fr); gap:10px; height:80vh; overflow-y:auto; background:rgba(0,0,0,0.3); padding:15px; border-radius:10px;"></div>
    </div>

    <div id="screen-battle">
        <div id="turn-indicator" style="grid-column:1/-1; text-align:center; padding:10px; font-weight:bold; letter-spacing:10px; background:#222;">WAITING...</div>
        <div style="display:flex; flex-direction:column; justify-content:space-between; height:calc(100vh - 45px);">
            <div id="opp-field" class="field"></div>
            <div id="my-field" class="field"></div>
            <div id="my-hand" style="display:flex; justify-content:center; gap:8px; padding:20px; background:rgba(0,0,0,0.6); min-height:170px;"></div>
        </div>
        <div class="sidebar">
            <div id="room-display" style="font-size:14px; color:var(--gold); margin-bottom:10px; text-align:center; background:rgba(20, 30, 48, 0.8); padding:8px; border-radius:8px; border:1px solid rgba(241, 196, 15, 0.3);">ãƒ«ãƒ¼ãƒ : <span id="current-room">----</span></div>
            <div style="font-size:18px; color:#aaa;">Day <span id="turn-txt" style="color:#fff;">1</span> / å¤©å€™: <span id="weather-txt" style="color:var(--gold);">æ™´å¤©</span></div>
            <div style="background:#222; padding:15px; border-radius:10px; border:1px solid #444; text-align:center;">
                <div style="font-size:12px; color:#888;">ç¾åœ¨ã®è¨ˆæ¸¬ã‚¹ã‚³ã‚¢</div>
                <div id="my-score" style="font-size:48px; color:var(--gold); font-weight:bold;">0</div>
                <hr style="border:0; border-top:1px solid #444; margin:10px 0;">
                <div style="font-size:12px; color:#888;">æ®‹ã‚ŠAP / æœ€å¤§AP</div>
                <div id="my-ap" style="font-size:28px; color:#2ecc71;">2/2</div>
            </div>
            <div id="log" class="log"></div>
            <button id="end-turn-btn" onclick="socket.emit('end_turn',{player_id:myId})" class="btn btn-gold" style="width:100%; font-size:20px;">ã‚¿ãƒ¼ãƒ³çµ‚äº†</button>
            <button id="shakapachi-btn" onclick="shuffleHand()" class="btn" style="width:100%; font-size:20px; background: linear-gradient(135deg, var(--purple), var(--cyan)); display:none;">ã—ã‚ƒã‹ã±ã¡</button>
        </div>
    </div>

    <script>
        const socket = io();
        let myId, myDeck = [];
        let lastTurn = null;
        let currentRoomId = null;        let isCPUMode = false;  // CPUæˆ¦ãƒ¢ãƒ¼ãƒ‰
        
        // ã—ã‚ƒã‹ã±ã¡ï¼šæ‰‹æœ­ã‚’åè»¢ã•ã›ã‚‹
        function shuffleHand() {
            const handContainer = document.getElementById('my-hand');
            const cards = Array.from(handContainer.children);
            
            // ã‚«ãƒ¼ãƒ‰ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            cards.forEach((card, i) => {
                const targetPos = cards.length - 1 - i;
                const offset = (targetPos - i) * 103; // ã‚«ãƒ¼ãƒ‰ã®å¹…+gap
                card.style.transition = 'transform 0.5s ease';
                card.style.transform = `translateX(${offset}px)`;
            });
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«å®Ÿéš›ã«é †åºã‚’å¤‰æ›´
            setTimeout(() => {
                cards.reverse();
                handContainer.innerHTML = '';
                cards.forEach(card => {
                    card.style.transform = '';
                    card.style.transition = '';
                    handContainer.appendChild(card);
                });
            }, 500);
        }

        // CPUæˆ¦é–‹å§‹
        function startCPUGame() {
            isCPUMode = true;
            console.log('CPUæˆ¦ãƒ¢ãƒ¼ãƒ‰é–‹å§‹:', isCPUMode);
            document.getElementById('screen-title').style.display = 'none';
            document.getElementById('screen-deck').style.display = 'block';
            renderDeckGrid();
            
            // ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ï¼‰
            socket.emit('create_room');
        }
        // ãƒ«ãƒ¼ãƒ ä½œæˆ
        function createRoom() {
            socket.emit('create_room');
        }

        // ãƒ«ãƒ¼ãƒ å‚åŠ ï¼ˆå…¥åŠ›ã‹ã‚‰ï¼‰
        function joinRoomByInput() {
            const roomId = document.getElementById('room-input').value.trim();
            if (roomId.length !== 4) {
                document.getElementById('room-status').textContent = '4æ¡ã®ãƒ«ãƒ¼ãƒ ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                return;
            }
            socket.emit('join_room', { room_id: roomId });
        }

        // ãƒ«ãƒ¼ãƒ ä½œæˆæˆåŠŸ
        socket.on('room_created', (data) => {
            currentRoomId = data.room_id;
            myId = data.player_id;  // P1ã¨ã—ã¦è‡ªå‹•å‰²ã‚Šå½“ã¦
            console.log('ãƒ«ãƒ¼ãƒ ä½œæˆ:', currentRoomId, 'CPUæˆ¦ãƒ¢ãƒ¼ãƒ‰:', isCPUMode);
            
            // CPUæˆ¦ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆæ—¢ã«ãƒ‡ãƒƒã‚­ç·¨æˆç”»é¢ã«è¡Œã£ã¦ã„ã‚‹ï¼‰
            if (!isCPUMode) {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šå¾…æ©Ÿç”»é¢ã¸
                document.getElementById('screen-title').style.display = 'none';
                document.getElementById('screen-waiting').style.display = 'flex';
                document.getElementById('waiting-room-number').textContent = currentRoomId;
            }
        });

        // ãƒ«ãƒ¼ãƒ å‚åŠ æˆåŠŸ
        socket.on('room_joined', (data) => {
            currentRoomId = data.room_id;
            myId = data.player_id;  // P2ã¨ã—ã¦è‡ªå‹•å‰²ã‚Šå½“ã¦
            // P2ã¯å¾…æ©Ÿã›ãšç›´æ¥ãƒ‡ãƒƒã‚­ç·¨æˆã¸ï¼ˆroom_readyã§é·ç§»ï¼‰
        });

        // 2äººæƒã£ãŸé€šçŸ¥
        socket.on('room_ready', (data) => {
            document.getElementById('screen-title').style.display = 'none';
            document.getElementById('screen-waiting').style.display = 'none';
            document.getElementById('screen-deck').style.display = 'block';
            renderDeckGrid();
        });

        // ã‚¨ãƒ©ãƒ¼å‡¦ç†
        socket.on('error', (data) => {
            document.getElementById('room-status').textContent = data.message;
        });

        // Pixabay APIã§ç¾å ´é¢¨ã®å®Ÿå†™èƒŒæ™¯ã‚’å–å¾—ï¼ˆç„¡æ–™ã€APIã‚­ãƒ¼ä¸è¦ï¼‰
        const bgUrls = [
            'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=1920&h=1080&fit=crop', // å·¥äº‹ç¾å ´
            'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=1920&h=1080&fit=crop', // å±±é“
            'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=1920&h=1080&fit=crop'  // éƒ½å¸‚é“è·¯
        ];
        const randomUrl = bgUrls[Math.floor(Math.random() * bgUrls.length)];
        
        // èƒŒæ™¯ç”»åƒã‚’è¨­å®š
        const bgElement = document.querySelector('.master-bg');
        bgElement.style.backgroundImage = `url('${randomUrl}')`;
        bgElement.style.opacity = '1';
        console.log(`ç¾å ´èƒŒæ™¯èª­è¾¼: ${randomUrl}`);

        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã¨æ–‡è¨€ã‚’åˆã‚ã›ã‚‹ï¼‰
        const MASTER_CARDS = [
            {id:"Newbie", name:"æ–°å…¥ç¤¾å“¡", cost:1, power:1, upkeep:0, type:"MACHINE", desc:"1æšå¼•ã"},
            {id:"Staff", name:"æ‹…å½“ç¤¾å“¡", cost:3, power:4, upkeep:1, type:"MACHINE", desc:"é€²åŒ–(1)"},
            {id:"Chief", name:"ä¸»ä»»æŠ€è¡“è€…", cost:5, power:8, upkeep:0, type:"MACHINE", desc:"é€²åŒ–(1)ç¶­æŒ0"},
            {id:"Senior", name:"æ•™è‚²ä¿‚", cost:2, power:3, upkeep:1, type:"MACHINE", desc:"æ–°å…¥ãƒ‘+3"},
            {id:"Ace", name:"ã‚¨ãƒ¼ã‚¹", cost:4, power:12, upkeep:2, type:"MACHINE", desc:"é«˜å‡ºåŠ›"},
            {id:"Leader", name:"ç¾å ´ä»£ç†äºº", cost:6, power:15, upkeep:1, type:"MACHINE", desc:"é«˜åŠ¹ç‡"},
            {id:"Expert", name:"è·äºº", cost:5, power:10, upkeep:2, type:"MACHINE", desc:"å®‰å®šè¨ˆæ¸¬"},
            {id:"Clerk", name:"äº‹å‹™å“¡", cost:2, power:1, upkeep:0, type:"MACHINE", desc:"æ¯AP+1"},
            {id:"Intern", name:"å®Ÿç¿’ç”Ÿ", cost:0, power:0, upkeep:0, type:"MACHINE", desc:"ã‚³ã‚¹ãƒˆ0"},
            {id:"SafetyOfficer", name:"å®‰å…¨å“¡", cost:3, power:2, upkeep:1, type:"MACHINE", desc:"é˜²è¡›"},
            {id:"LevelBasic", name:"æ™®é€šãƒ¬ãƒ™ãƒ«", cost:1, power:2, upkeep:1, type:"MACHINE", desc:"åŸºæœ¬"},
            {id:"LevelAuto", name:"ã‚ªãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«", cost:3, power:6, upkeep:1, type:"MACHINE", desc:"é€²åŒ–(1)"},
            {id:"StaffBasic", name:"ã‚¢ãƒ«ãƒŸS", cost:1, power:2, upkeep:1, type:"MACHINE", desc:"åŸºæœ¬"},
            {id:"StaffRef", name:"åå°„S", cost:3, power:7, upkeep:1, type:"MACHINE", desc:"é€²åŒ–(1)"},
            {id:"TS", name:"å…‰æ³¢TS", cost:4, power:10, upkeep:2, type:"MACHINE", desc:"ä¸»åŠ›"},
            {id:"GNSS", name:"GNSS", cost:6, power:18, upkeep:3, type:"MACHINE", desc:"æ™´å¤©+5"},
            {id:"Drone", name:"ãƒ‰ãƒ­ãƒ¼ãƒ³", cost:5, power:14, upkeep:2, type:"MACHINE", desc:"éœ§ç„¡åŠ¹"},
            {id:"Scanner", name:"3Dã‚¹ã‚­ãƒ£ãƒŠ", cost:8, power:25, upkeep:3, type:"MACHINE", desc:"æœ€å¼·å‡ºåŠ›"},
            {id:"UsedTS", name:"ä¸­å¤TS", cost:2, power:12, upkeep:2, type:"MACHINE", desc:"é«˜ç¶­æŒè²»"},
            {id:"Laser", name:"ãƒ¬ãƒ¼ã‚¶ãƒ¼", cost:2, power:5, upkeep:1, type:"MACHINE", desc:"å®¤å†…"},
            {id:"Compass", name:"ç£çŸ³", cost:1, power:1, upkeep:0, type:"MACHINE", desc:"æ–¹ä½"},
            {id:"Tripod", name:"ä¸‰è„š", cost:1, power:1, upkeep:0, type:"MACHINE", desc:"åŸºæœ¬"},
            {id:"Caliper", name:"ãƒã‚®ã‚¹", cost:1, power:2, upkeep:1, type:"MACHINE", desc:"ç²¾å¯†"},
            {id:"Scale", name:"ã‚¹ã‚±ãƒ¼ãƒ«", cost:1, power:1, upkeep:0, type:"MACHINE", desc:"åŸºæœ¬"},
            {id:"Chalk", name:"ãƒãƒ§ãƒ¼ã‚¯", cost:1, power:1, upkeep:0, type:"MACHINE", desc:"å°"},
            {id:"Excavator", name:"é‡æ©Ÿ", cost:7, power:20, upkeep:4, type:"MACHINE", desc:"å¼·åŠ›"},
            {id:"Rental", name:"ãƒ¬ãƒ³ã‚¿ãƒ«", cost:3, power:15, upkeep:5, type:"MACHINE", desc:"ä¸€æ™‚çš„"},
            {id:"SmallTruck", name:"è»½ãƒˆãƒ©", cost:2, power:1, upkeep:0, type:"MACHINE", desc:"è¨­ç½®å®‰"},
            {id:"Concrete", name:"ç”Ÿã‚³ãƒ³", cost:5, power:10, upkeep:3, type:"MACHINE", desc:"é›¨-5"},
            {id:"Pump", name:"ãƒãƒ³ãƒ—", cost:3, power:0, upkeep:1, type:"MACHINE", desc:"é›¨ç„¡åŠ¹"},
            {id:"GenSet", name:"ç™ºé›»æ©Ÿ", cost:3, power:3, upkeep:1, type:"MACHINE", desc:"å…¨ä½“+2"},
            {id:"Radio", name:"ç„¡ç·šæ©Ÿ", cost:2, power:2, upkeep:1, type:"MACHINE", desc:"ç©ºå¼·åŒ–"},
            {id:"Lights", name:"æŠ•å…‰å™¨", cost:3, power:4, upkeep:1, type:"MACHINE", desc:"å¾ŒåŠå¼·"},
            {id:"Helmet", name:"ãƒ¡ãƒƒãƒˆ", cost:1, power:0, upkeep:0, type:"MACHINE", desc:"ç¤¾å“¡-1"},
            {id:"Barrier", name:"çœ‹æ¿", cost:2, power:0, upkeep:1, type:"MACHINE", desc:"å¦¨å®³"},
            {id:"Elite", name:"å°‘æ•°ç²¾é‹­", cost:2, power:0, upkeep:0, type:"SPELL", desc:"2æšå¼•"},
            {id:"Decision", name:"æ±ºæ–­", cost:0, power:0, upkeep:0, type:"SPELL", desc:"APæœ€å¤§+2"},
            {id:"Fund", name:"è³‡é‡‘èª¿é”", cost:4, power:0, upkeep:0, type:"SPELL", desc:"APæœ€å¤§+1"},
            {id:"Transceiver", name:"ç¤¾å“¡å‘¼å‡º", cost:1, power:0, upkeep:0, type:"SPELL", desc:"1æšå¼•"},
            {id:"Safety", name:"å®‰å…¨å·¡å›", cost:3, power:0, upkeep:0, type:"SPELL", desc:"æ•µAPæ¸›"},
            {id:"Lost", name:"ç´›å¤±", cost:3, power:0, upkeep:0, type:"SPELL", desc:"ç ´å£Š"},
            {id:"Note", name:"é‡å¸³", cost:1, power:0, upkeep:0, type:"SPELL", desc:"2æšå¼•"},
            {id:"Repair", name:"ä¿®ç†", cost:2, power:0, upkeep:0, type:"SPELL", desc:"AP5å›å¾©"},
            {id:"Check", name:"Wãƒã‚§ãƒƒã‚¯", cost:2, power:0, upkeep:0, type:"SPELL", desc:"3æšå¼•"},
            {id:"Bush", name:"è—ªæ‰•ã„", cost:2, power:0, upkeep:0, type:"SPELL", desc:"å°ç²’ç ´å£Š"},
            {id:"Rush", name:"çªè²«", cost:0, power:0, upkeep:0, type:"SPELL", desc:"AP+4/å£Š"},
            {id:"Consult", name:"äºˆå ±", cost:1, power:0, upkeep:0, type:"SPELL", desc:"æ™´å¤©"},
            {id:"Training", name:"æ‰‹å½“", cost:2, power:0, upkeep:0, type:"SPELL", desc:"ç¤¾å“¡å¼·åŒ–"},
            {id:"NightWork", name:"å¾¹å¤œ", cost:0, power:0, upkeep:0, type:"SPELL", desc:"APå…¨å¿«"},
            {id:"Complaint", name:"è‹¦æƒ…", cost:3, power:0, upkeep:0, type:"SPELL", desc:"ç›¸æ‰‹APæ¸›"},
            {id:"Boundary", name:"å¢ƒç•Œ", cost:2, power:0, upkeep:0, type:"SPELL", desc:"åœæ­¢"},
            {id:"Overtime", name:"æ®‹æ¥­", cost:0, power:0, upkeep:0, type:"SPELL", desc:"å¼•/AP+"},
            {id:"Audit", name:"ç›£æŸ»", cost:4, power:0, upkeep:0, type:"SPELL", desc:"æœ€å¤§APæ¸›"},
            {id:"Goal30", name:"å·¥æœŸå®Œé‚", cost:4, power:0, upkeep:0, type:"GOAL", desc:"30ã§å‹åˆ©"},
            {id:"GoalFinal", name:"ç¤¾é•·æ±ºè£", cost:10, power:0, upkeep:0, type:"GOAL", desc:"10ã§å‹åˆ©"}
        ];

        function init(id) {
            myId = id;
            document.getElementById('screen-title').style.display = 'none';
            document.getElementById('screen-deck').style.display = 'block';
            renderDeckGrid();
        }

        function addCard(cardId, event) {
            if (event) event.stopPropagation();
            const count = myDeck.filter(id => id === cardId).length;
            if (count >= 4) {
                return; // 4æšåˆ¶é™
            }
            if (myDeck.length >= 40) {
                alert("ãƒ‡ãƒƒã‚­ã¯æœ€å¤§40æšã§ã™ï¼");
                return;
            }
            myDeck.push(cardId);
            document.getElementById('deck-count').innerText = myDeck.length;
            renderDeckGrid();
        }

        function removeCard(cardId, event) {
            if (event) event.stopPropagation();
            const idx = myDeck.indexOf(cardId);
            if (idx !== -1) {
                myDeck.splice(idx, 1);
                document.getElementById('deck-count').innerText = myDeck.length;
                renderDeckGrid();
            }
        }

        function renderDeckGrid() {
            const grid = document.getElementById('deck-grid');
            grid.innerHTML = "";
            MASTER_CARDS.forEach(c => {
                const currentCount = myDeck.filter(id => id === c.id).length;
                const d = document.createElement('div');
                d.className = `card ${c.type}`;
                
                // ãƒ‡ãƒƒã‚­ã«å…¥ã£ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã¯å…‰ã‚‰ã›ã‚‹
                if (currentCount > 0) {
                    d.classList.add('in-deck');
                }
                
                d.style.position = 'relative';
                d.innerHTML = `
                    <div class="cost">${c.cost}</div>
                    <b>${c.name}</b><br><small>${c.desc}</small>
                    <div class="upkeep">ç¶­æŒ:${c.upkeep}</div>
                    <div class="power">${c.power || ''}</div>
                    <div class="deck-badge">${currentCount}</div>
                    <div style="position:absolute; bottom:35px; left:0; right:0; display:flex; gap:5px; justify-content:center;">
                        <button onclick="removeCard('${c.id}', event)" class="deck-btn" style="background:#e74c3c; width:35px; height:30px; border:none; border-radius:5px; color:#fff; font-size:18px; cursor:pointer; font-weight:bold;">âˆ’</button>
                        <button onclick="addCard('${c.id}', event)" class="deck-btn" style="background:#27ae60; width:35px; height:30px; border:none; border-radius:5px; color:#fff; font-size:18px; cursor:pointer; font-weight:bold;">ï¼‹</button>
                    </div>
                `;
                
                // ã‚«ãƒ¼ãƒ‰å…¨ä½“ã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼ˆå¾“æ¥ã®æ©Ÿèƒ½ã‚‚ç¶­æŒï¼‰
                d.onclick = (e) => {
                    if (!e.target.classList.contains('deck-btn') && e.target.tagName !== 'BUTTON') {
                        addCard(c.id);
                    }
                };
                grid.appendChild(d);
            });
        }

        function loadDeck(mode) {
            const presets = {
                // ç¤¾å“¡è‚²æˆãƒ‡ãƒƒã‚­ï¼šç¤¾å“¡ã‚«ãƒ¼ãƒ‰ã¨Trainingï¼ˆç ”ä¿®ï¼‰ã§å¼·åŒ–ã—ã¦ã„ãæˆ¦ç•¥
                TRAINING: [
                    "Newbie","Newbie","Newbie","Newbie","Newbie","Newbie",  // æ–°å…¥ç¤¾å“¡ã‚’å¤§é‡æŠ•å…¥
                    "Staff","Staff","Staff","Staff",  // é€²åŒ–å…ˆ
                    "Chief","Chief","Chief",  // æœ€çµ‚é€²åŒ–
                    "Senior","Senior","Senior","Senior",  // æ–°å…¥ç¤¾å“¡ã‚’å¼·åŒ–
                    "Ace","Ace","Ace",  // ç¾å ´ã®ã‚¨ãƒ¼ã‚¹
                    "Expert","Expert","Expert",  // ãƒ™ãƒ†ãƒ©ãƒ³è·äºº
                    "Clerk","Clerk","Clerk","Clerk",  // äº‹å‹™å“¡ã§APå›å¾©
                    "SafetyOfficer","SafetyOfficer",  // å®‰å…¨ç®¡ç†
                    "Training","Training","Training",  // ç ”ä¿®ã§ç¤¾å“¡å¼·åŒ–
                    "Elite","Elite",  // å°‘æ•°ç²¾é‹­
                    "Note","Note","Check","Check",  // ãƒ‰ãƒ­ãƒ¼
                    "Repair","Repair","Overtime","Overtime",  // APç®¡ç†
                    "Decision","Fund",  // æœ€å¤§APå¢—åŠ 
                    "Lost","Bush",  // é™¤å»
                    "Goal30","GoalFinal"  // å‹åˆ©æ¡ä»¶
                ],
                
                // æ¸¬é‡æ©Ÿæ¢°ãƒ‡ãƒƒã‚­ï¼šæ¸¬é‡æ©Ÿå™¨ã®é€²åŒ–ãƒ©ã‚¤ãƒ³ã‚’æ´»ã‹ã™æ­£çµ±æ´¾
                SURVEY: [
                    "LevelBasic","LevelBasic","LevelBasic","LevelBasic",  // ãƒ¬ãƒ™ãƒ«åŸºæœ¬
                    "LevelAuto","LevelAuto","LevelAuto","LevelAuto",  // ã‚ªãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«é€²åŒ–
                    "StaffBasic","StaffBasic","StaffBasic","StaffBasic",  // ã‚¹ã‚¿ãƒƒãƒ•åŸºæœ¬
                    "StaffRef","StaffRef","StaffRef","StaffRef",  // åå°„ã‚¹ã‚¿ãƒƒãƒ•é€²åŒ–
                    "TS","TS","TS","TS",  // å…‰æ³¢ãƒˆãƒ¼ã‚¿ãƒ«ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
                    "Drone","Drone","Drone","Drone",  // ãƒ‰ãƒ­ãƒ¼ãƒ³ï¼ˆéœ§ã«å¼·ã„ï¼‰
                    "Laser","Laser","Laser",  // ãƒ¬ãƒ¼ã‚¶ãƒ¼å¢¨å‡ºã—
                    "Compass","Tripod","Tripod",  // è£œåŠ©æ©Ÿæ
                    "GenSet","GenSet","GenSet",  // ç™ºé›»æ©Ÿã§å…¨ä½“å¼·åŒ–
                    "SmallTruck","SmallTruck",  // è»½ãƒˆãƒ©ã§è¨­ç½®ã‚µãƒãƒ¼ãƒˆ
                    "Note","Note","Check","Check",  // ãƒ‰ãƒ­ãƒ¼
                    "Repair","Repair","Overtime","Overtime",  // APç®¡ç†
                    "Consult","Consult",  // å¤©å€™æ“ä½œ
                    "Lost","Bush",  // é™¤å»
                    "Goal30","GoalFinal"  // å‹åˆ©æ¡ä»¶
                ],
                
                // é‡æ©ŸåœŸæœ¨ãƒ‡ãƒƒã‚­ï¼šå¤§å‹é‡æ©Ÿã¨ãƒ‘ãƒ¯ãƒ¼ã§åœ§å€’ã™ã‚‹
                CONSTRUCTION: [
                    "Excavator","Excavator","Excavator","Excavator",  // ãƒãƒƒã‚¯ãƒ›ãƒ¼
                    "Rental","Rental","Rental",  // ãƒ¬ãƒ³ã‚¿ãƒ«é‡æ©Ÿ
                    "Concrete","Concrete","Concrete","Concrete",  // ç”Ÿã‚³ãƒ³è»Š
                    "Pump","Pump","Pump",  // æ’æ°´ãƒãƒ³ãƒ—ï¼ˆé›¨å¯¾ç­–ï¼‰
                    "GNSS","GNSS","GNSS",  // GNSSè¡›æ˜Ÿ
                    "Scanner","Scanner","Scanner",  // 3Dã‚¹ã‚­ãƒ£ãƒŠ
                    "UsedTS","UsedTS","UsedTS",  // ä¸­å¤TS
                    "GenSet","GenSet","GenSet",  // ç™ºé›»æ©Ÿ
                    "Lights","Lights","Lights",  // æŠ•å…‰å™¨
                    "Intern","Intern","Intern",  // å®Ÿç¿’ç”Ÿï¼ˆå›®ï¼‰
                    "Clerk","Clerk","Clerk",  // äº‹å‹™å“¡ï¼ˆAPå›å¾©ï¼‰
                    "Rush","Rush","Rush",  // çªè²«å·¥äº‹
                    "Note","Note","Elite",  // ãƒ‰ãƒ­ãƒ¼
                    "NightWork","Repair","Overtime","Overtime",  // APå¤§é‡ç®¡ç†
                    "Decision","Fund",  // æœ€å¤§APå¢—åŠ 
                    "Lost","Bush",  // é™¤å»
                    "Goal30","GoalFinal"  // å‹åˆ©æ¡ä»¶
                ]
            };
            myDeck = [...presets[mode]];
            document.getElementById('deck-count').innerText = myDeck.length;
            renderDeckGrid();
        }

        function submitDeck() {
            if(myDeck.length < 40) return alert("40æšé¸ã‚“ã§ãã ã•ã„ï¼");
            socket.emit('submit_deck', {player_id: myId, deck: myDeck});
            
            // CPUæˆ¦ãƒ¢ãƒ¼ãƒ‰ï¼šCPUã®ãƒ‡ãƒƒã‚­ã‚‚è‡ªå‹•æå‡º
            if (isCPUMode) {
                // CPUã¯æ¸¬é‡æ©Ÿæ¢°ãƒ‡ãƒƒã‚­ã‚’ä½¿ç”¨
                const cpuDeck = [
                    "LevelBasic","LevelBasic","LevelBasic",
                    "LevelAuto","LevelAuto","LevelAuto",
                    "StaffBasic","StaffBasic","StaffBasic",
                    "StaffRef","StaffRef","StaffRef",
                    "TS","TS","TS","TS",
                    "Drone","Drone","Drone",
                    "Laser","Laser",
                    "Compass","Tripod","Tripod",
                    "GenSet","GenSet",
                    "SmallTruck","SmallTruck",
                    "Note","Note","Check","Check",
                    "Repair","Repair","Overtime",
                    "Consult","Consult",
                    "Lost","Boundary",
                    "Goal30","Goal30","GoalFinal"
                ];
                setTimeout(() => {
                    socket.emit('submit_deck', {player_id: 'p2', deck: cpuDeck});
                }, 500);
            }
            
            document.getElementById('screen-deck').style.display = 'none';
            document.getElementById('screen-battle').style.display = 'grid';
        }

        function backToTitle() {
            socket.emit('reset_game');
            setTimeout(() => { location.reload(); }, 100);
        }
        
        // CPUæ€è€ƒãƒ­ã‚¸ãƒƒã‚¯
        function cpuTurn(gameState) {
            const cpu = gameState.players.p2;
            console.log('CPUæ€è€ƒé–‹å§‹ AP:', cpu.ap, 'æ‰‹æœ­:', cpu.hand.length);
            
            // 1. å‹åˆ©ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã€ã‚¹ã‚³ã‚¢ãŒè¶³ã‚Šã¦ã„ã‚Œã°ä½¿ã†
            for (let i = 0; i < cpu.hand.length; i++) {
                const card = cpu.hand[i];
                if ((card.id === 'Goal30' && cpu.score >= 30) || (card.id === 'GoalFinal' && cpu.score >= 10)) {
                    if (cpu.ap >= card.cost) {
                        console.log('CPUå‹åˆ©ã‚«ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ¬ã‚¤:', card.name);
                        socket.emit('play_card', {player_id: 'p2', card_index: i});
                        return;
                    }
                }
            }
            
            // 2. APãŒã‚ã‚‹é™ã‚Šã€ã‚³ã‚¹ãƒˆãŒä½ã„é †ã«ã‚«ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ¬ã‚¤ï¼ˆå…ƒã®é…åˆ—ã‚’å¤‰æ›´ã—ãªã„ï¼‰
            const sortedIndices = cpu.hand.map((c, idx) => ({card: c, index: idx}))
                                           .sort((a, b) => a.card.cost - b.card.cost);
            
            for (let item of sortedIndices) {
                const card = item.card;
                const i = item.index;
                
                // ã‚¹ãƒšãƒ«ã‚«ãƒ¼ãƒ‰ã¯è±ªé›¨æ™‚ã‚¹ã‚­ãƒƒãƒ—
                if (gameState.weather === 'è±ªé›¨' && card.type === 'SPELL') continue;
                
                // é€²åŒ–ã‚«ãƒ¼ãƒ‰ã®å‡¦ç†
                const evoMap = {
                    'Staff': 'Newbie', 'Chief': 'Staff',
                    'LevelAuto': 'LevelBasic', 'StaffRef': 'StaffBasic'
                };
                
                if (evoMap[card.id]) {
                    const hasBase = cpu.field.some(c => c.id === evoMap[card.id]);
                    if (hasBase && cpu.ap >= 1) {
                        console.log('CPUé€²åŒ–ã‚«ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ¬ã‚¤:', card.name, 'index:', i);
                        socket.emit('play_card', {player_id: 'p2', card_index: i});
                        return;
                    }
                }
                
                // é€šå¸¸ãƒ—ãƒ¬ã‚¤
                if (cpu.ap >= card.cost) {
                    console.log('CPUã‚«ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ¬ã‚¤:', card.name, 'cost:', card.cost, 'index:', i);
                    socket.emit('play_card', {player_id: 'p2', card_index: i});
                    return;
                }
            }
            
            // 3. ã‚‚ã†ãƒ—ãƒ¬ã‚¤ã§ããªã„ã®ã§ã‚¿ãƒ¼ãƒ³çµ‚äº†
            console.log('CPUã‚¿ãƒ¼ãƒ³çµ‚äº†ã‚’é€ä¿¡');
            setTimeout(() => { socket.emit('end_turn', {player_id: 'p2'}); }, 1000);
        }
        
        function selectTarget(idx) {
            socket.emit('select_target', {player_id: myId, target_index: idx});
        }
        
        // CPUç”¨ã®é¸æŠå‡¦ç†
        function cpuSelectTarget(gameState) {
            if (!gameState.pending_selection || gameState.pending_selection.player !== 'p2') return;
            
            const targets = gameState.pending_selection.targets;
            if (targets.length > 0) {
                // ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
                const randomTarget = targets[Math.floor(Math.random() * targets.length)];
                setTimeout(() => {
                    socket.emit('select_target', {player_id: 'p2', target_index: randomTarget});
                }, 1000);
            }
        }

        socket.on('update_ui', s => {
            // ãƒ«ãƒ¼ãƒ ç•ªå·ã‚’è¡¨ç¤º
            if (currentRoomId) {
                document.getElementById('current-room').textContent = currentRoomId;
            }
            
            const me = s.players[myId], opp = s.players[myId==='p1'?'p2':'p1'];
            const ind = document.getElementById('turn-indicator');
            
            ind.innerText = s.turn === myId ? "YOUR TURN" : "ENEMY TURN";
            ind.style.color = s.turn === myId ? "var(--blue)" : "var(--red)";
            
            // ã‚¿ãƒ¼ãƒ³çµ‚äº†ãƒœã‚¿ãƒ³ã¨ã—ã‚ƒã‹ã±ã¡ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            const endTurnBtn = document.getElementById('end-turn-btn');
            const shakapachiBtn = document.getElementById('shakapachi-btn');
            if (s.turn === myId) {
                endTurnBtn.style.display = 'block';
                shakapachiBtn.style.display = 'none';
            } else {
                endTurnBtn.style.display = 'none';
                shakapachiBtn.style.display = 'block';
            }

            // ä¿®æ­£ï¼šã‚¿ãƒ¼ãƒ³æ¼”å‡ºã«å¤©å€™ã‚’è¿½åŠ 
            if (lastTurn && lastTurn !== s.turn) {
                const ov = document.getElementById('turn-overlay');
                const txt = document.getElementById('turn-overlay-text');
                txt.innerHTML = `Day ${s.turn_count} <br> PLAYER ${s.turn === 'p1' ? '1' : '2'} <br> <div style="font-size:40px; margin-top:10px;">${s.weather}</div>`;
                ov.style.display = 'flex';
                setTimeout(() => { ov.style.display = 'none'; }, 2000);
            }
            lastTurn = s.turn;
            
            // CPUæˆ¦ãƒ¢ãƒ¼ãƒ‰ï¼šCPUã®ã‚¿ãƒ¼ãƒ³ãªã‚‰å¸¸ã«è‡ªå‹•ãƒ—ãƒ¬ã‚¤ï¼ˆã‚¿ãƒ¼ãƒ³å¤‰æ›´æ™‚ã ã‘ã§ãªãã€ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¬ã‚¤å¾Œã‚‚ï¼‰
            if (isCPUMode && s.turn === 'p2' && !s.pending_selection && !s.winner) {
                setTimeout(() => { cpuTurn(s); }, 1500);
            }

            document.getElementById('my-score').innerText = me.score;
            document.getElementById('my-ap').innerText = `${me.ap}/${me.max_ap}`;
            document.getElementById('weather-txt').innerText = s.weather;
            document.getElementById('turn-txt').innerText = s.turn_count;
            
            // CPUæˆ¦ï¼šCPUãŒé¸æŠã‚’æ±‚ã‚ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆã¯è‡ªå‹•é¸æŠ
            if (isCPUMode && s.pending_selection && s.pending_selection.player === 'p2') {
                cpuSelectTarget(s);
            }
            
            // é¸æŠãƒ¢ãƒ¼ãƒ‰ä¸­ã‹ãƒã‚§ãƒƒã‚¯
            const isSelectMode = s.pending_selection && s.pending_selection.player === myId;
            const selectType = isSelectMode ? s.pending_selection.type : null;
            const selectTargets = isSelectMode ? s.pending_selection.targets : [];
            
            const render = (c, i, isMe, canSelect) => {
                const selectClass = canSelect ? 'card-selectable' : '';
                const onclick = canSelect ? `selectTarget(${i})` : (isMe ? `socket.emit('play_card',{player_id:myId,card_index:${i}})` : '');
                const frozen = c.frozen || 0;
                return `
                    <div class="card ${c.type} ${selectClass}" onclick="${onclick}">
                        <div class="cost">${c.cost}</div><b>${c.name}</b><br><small>${c.desc}</small>
                        <div class="upkeep">ç¶­æŒ:${c.upkeep||0}</div>
                        <div class="power">${c.power||''}</div>
                        ${frozen > 0 ? '<div style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(100,150,255,0.5);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;color:#fff;">å‡çµ</div>' : ''}
                    </div>`;
            };
            
            // é¸æŠUIã®è¡¨ç¤º
            if (isSelectMode) {
                ind.innerText = "ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„";
                ind.style.color = "var(--gold)";
            }
            
            document.getElementById('my-hand').innerHTML = me.hand.map((c, i) => render(c, i, !isSelectMode, false)).join('');
            
            // è‡ªåˆ†ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆbuff_ally, sacrificeç³»ã®é¸æŠå¯¾è±¡ï¼‰
            const myFieldSelectable = isSelectMode && ['buff_ally', 'sacrifice_for_upkeep', 'sacrifice_for_rush'].includes(selectType);
            document.getElementById('my-field').innerHTML = me.field.map((c, i) => 
                render(c, i, false, myFieldSelectable && selectTargets.includes(i))
            ).join('');
            
            // ç›¸æ‰‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆdestroy_enemy, freeze_enemyç³»ã®é¸æŠå¯¾è±¡ï¼‰
            const oppFieldSelectable = isSelectMode && ['destroy_enemy', 'freeze_enemy'].includes(selectType);
            document.getElementById('opp-field').innerHTML = opp.field.map((c, i) => 
                render(c, i, false, oppFieldSelectable && selectTargets.includes(i))
            ).join('');
            
            // ãƒ­ã‚°ã®è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’å°‘ã—è¦‹ã‚„ã™ãï¼ˆã‚«ãƒ¼ãƒ‰åãŒã‚ã‚Œã°MASTER_CARDSã‹ã‚‰è©³ç´°ã‚’å–å¾—ï¼‰
            document.getElementById('log').innerHTML = s.log.slice(-12).map(l => {
                // ã‚«ãƒ¼ãƒ‰åã‚’æ¤œå‡ºã—ã¦åŠ¹æœã‚’è¿½åŠ 
                let enhanced = l;
                MASTER_CARDS.forEach(card => {
                    const regex = new RegExp(`ã€Œ${card.name}ã€`, 'g');
                    if (regex.test(l)) {
                        enhanced = enhanced.replace(regex, `ã€Œ${card.name}(${card.desc})ã€`);
                    }
                });
                return `<div>> ${enhanced}</div>`;
            }).join('');

            if(s.winner) {
                const modal = document.getElementById('result-modal');
                const title = document.getElementById('result-title');
                modal.style.display = 'flex';
                if (s.winner === myId) {
                    title.innerText = "è¦³æ¸¬å®Œäº†ï¼";
                    title.style.color = "var(--gold)";
                } else {
                    title.innerText = "è¦³æ¸¬å¤±æ•—ï¼";
                    title.style.color = "#888";
                }
            }
        });
    </script>
</body>
</html>

