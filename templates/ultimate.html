<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>観測君VS ULTIMATE Ver 3.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root { 
            --gold: #ffdf00; 
            --blue: #3498db; 
            --red: #e74c3c; 
            --purple: #9b59b6;
            --green: #2ecc71;
            --orange: #e67e22;
            --cyan: #1abc9c;
            --dark: #1a1a1a; 
        }
        body { margin: 0; color: white; font-family: 'Helvetica', sans-serif; background: #000; overflow: hidden; }
        
        /* 実写背景 */
        .master-bg { 
            position: fixed; inset: 0; z-index: -10; 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: opacity 1s ease;
        }
        
        /* 背景のオーバーレイ（見やすくするため） */
        .master-bg::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(1px);
        }
        
        /* ほこりや光の粒子エフェクト */
        .master-bg::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(255, 255, 200, 0.15) 0%, transparent 30%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 200, 0.1) 0%, transparent 25%),
                radial-gradient(circle at 40% 80%, rgba(255, 255, 255, 0.08) 0%, transparent 20%);
            animation: dustFloat 25s ease infinite;
            z-index: 1;
        }
        
        @keyframes dustFloat {
            0%, 100% { transform: translate(0, 0); opacity: 0.6; }
            25% { transform: translate(15px, -15px); opacity: 0.8; }
            50% { transform: translate(-10px, 15px); opacity: 0.5; }
            75% { transform: translate(20px, 10px); opacity: 0.7; }
        }
        
        /* カード基本スタイル - よりカラフルに */
        .card { 
            width: 95px; height: 145px; 
            background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
            border-radius: 8px; color: #222; padding: 6px; 
            position: relative; cursor: pointer; font-size: 10px; 
            border: 2px solid #999; box-sizing: border-box; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .card:hover { 
            transform: translateY(-8px) scale(1.05); 
            border-color: var(--gold); 
            box-shadow: 0 10px 30px rgba(255,223,0,0.4), 0 0 20px rgba(255,223,0,0.2);
        }
        .card.MACHINE { 
            border-top: 6px solid var(--blue); 
            background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
        }
        .card.SPELL { 
            border-top: 6px solid var(--red); 
            background: linear-gradient(135deg, #ffffff 0%, #ffebee 100%);
        }
        .card.GOAL { 
            border: 3px solid var(--gold); 
            background: linear-gradient(135deg, #fff9c4 0%, #ffeb3b 100%);
            box-shadow: 0 0 20px rgba(255, 223, 0, 0.5);
        }
        
        /* カード内ステータス */
        .cost { position: absolute; top: -8px; left: -8px; background: var(--gold); border-radius: 50%; width: 24px; height: 24px; text-align: center; font-weight: bold; border: 1.5px solid #000; line-height: 24px; z-index: 2; color: #000; }
        .upkeep { position: absolute; bottom: 5px; left: 5px; color: var(--red); font-weight: bold; font-size: 9px; }
        .power { position: absolute; bottom: 3px; right: 5px; font-size: 18px; font-weight: 900; color: var(--blue); }
        
        /* カード名と効果のレイアウト */
        .card b { margin-left: 14px; display: inline-block; font-size: 11px; margin-bottom: 2px;}
        .card small { display: block; line-height: 1.2; font-size: 9px; color: #444; height: 95px; overflow: hidden; }

        /* デッキ枚数バッジ */
        .deck-badge { position: absolute; top: 0px; right: 0px; background: #000; color: #fff; padding: 2px 6px; border-radius: 0 8px 0 8px; font-weight: bold; font-size: 12px; border: 1px solid var(--gold); z-index: 5; }
        
        /* デッキに入れたカードを光らせる */
        .card.in-deck {
            border: 2px solid var(--gold);
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.6), 0 0 40px rgba(241, 196, 15, 0.3);
            animation: deckGlow 2s ease-in-out infinite;
            transform: translateY(-2px);
        }
        
        @keyframes deckGlow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(241, 196, 15, 0.6), 0 0 40px rgba(241, 196, 15, 0.3);
            }
            50% { 
                box-shadow: 0 0 30px rgba(241, 196, 15, 0.8), 0 0 60px rgba(241, 196, 15, 0.5);
            }
        }

        /* レイアウト */
        #screen-battle { display: none; grid-template-columns: 1fr 300px; height: 100vh; }
        .sidebar { 
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
            border-left: 3px solid var(--cyan); 
            padding: 20px; display: flex; flex-direction: column; gap: 10px;
            box-shadow: -5px 0 20px rgba(26, 188, 156, 0.3);
        }
        .field { 
            display: flex; justify-content: center; gap: 10px; 
            min-height: 170px; 
            border-bottom: 2px solid rgba(52, 152, 219, 0.5); 
            align-items: center;
            background: linear-gradient(90deg, 
                rgba(52, 152, 219, 0.05) 0%, 
                rgba(155, 89, 182, 0.05) 50%, 
                rgba(52, 152, 219, 0.05) 100%
            );
            padding: 10px 0;
        }
        .log { 
            flex-grow: 1; overflow-y: auto; 
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e);
            padding: 10px; font-size: 11px; 
            color: #0ff; 
            border: 2px solid var(--cyan); 
            font-family: monospace;
            box-shadow: inset 0 0 20px rgba(26, 188, 156, 0.2);
        }

        /* タイトル・ルール */
        #rules-box { 
            background: linear-gradient(135deg, rgba(20, 30, 48, 0.95), rgba(30, 20, 45, 0.95));
            backdrop-filter: blur(10px);
            padding: 20px; 
            border-radius: 15px; 
            margin-top: 20px; 
            font-size: 13px; 
            line-height: 1.8; 
            max-width: 650px;
            border: 2px solid rgba(52, 152, 219, 0.6);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.7), 0 0 20px rgba(52, 152, 219, 0.3);
        }
        #rules-box h3 {
            color: var(--gold);
            text-shadow: 0 0 15px rgba(241, 196, 15, 0.6);
            border-bottom: 2px solid rgba(241, 196, 15, 0.3);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .rule-tag { 
            color: var(--cyan); 
            font-weight: bold; 
            margin-right: 5px;
            text-shadow: 0 0 10px rgba(26, 188, 156, 0.8);
        }

        /* ボタン - よりカラフルに */
        .btn { 
            padding: 12px 24px; border: none; border-radius: 8px; 
            font-weight: bold; cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn-gold { 
            background: linear-gradient(135deg, var(--gold) 0%, #ffa500 100%);
            color: #000;
            box-shadow: 0 4px 15px rgba(255, 223, 0, 0.4);
        }
        .btn-gold:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 223, 0, 0.6);
        }

        /* ターン演出オーバーレイ */
        #turn-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.95) 100%);
            display: none; justify-content: center; align-items: center;
            z-index: 1000; pointer-events: none;
        }
        #turn-overlay-text {
            font-size: 80px; font-weight: 900; 
            background: linear-gradient(135deg, var(--gold), var(--orange), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            border: 5px solid var(--gold); 
            padding: 20px 60px; 
            background-color: rgba(34, 34, 34, 0.9);
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(255, 223, 0, 0.6), inset 0 0 40px rgba(255, 223, 0, 0.2);
            animation: turnPulse 0.5s ease-in-out;
        }
        
        @keyframes turnPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* リザルト画面 */
        #result-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.98) 100%);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000;
        }
        #result-title { 
            font-size: 60px; font-weight: bold; margin-bottom: 30px;
            text-shadow: 0 0 30px currentColor;
            animation: resultGlow 2s ease-in-out infinite;
        }
        
        @keyframes resultGlow {
            0%, 100% { text-shadow: 0 0 20px currentColor; }
            50% { text-shadow: 0 0 40px currentColor, 0 0 60px currentColor; }
        }
        
        /* 選択モード */
        .card-selectable { 
            border: 3px solid var(--gold) !important; 
            animation: pulseSelect 1s infinite;
            box-shadow: 0 0 30px rgba(255, 223, 0, 0.6) !important;
        }
        @keyframes pulseSelect {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(255, 223, 0, 0.6);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 40px rgba(255, 223, 0, 0.9);
                transform: scale(1.05);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="master-bg"></div>

    <div id="turn-overlay"><div id="turn-overlay-text"></div></div>

    <div id="result-modal">
        <div id="result-title"></div>
        <button class="btn btn-gold" onclick="backToTitle()">タイトルに戻る</button>
    </div>

    <div id="screen-title" style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
        <h1 style="color:var(--gold); font-size:64px; text-shadow: 0 0 20px var(--gold); margin:0;">観測君VS ULTIMATE</h1>
        <p style="color:#888; letter-spacing: 5px;">VER 4.1</p>
        
        <div id="rules-box">
            <h3 style="margin-top:0;">現場監督の心得（ルール説明）</h3>
            <div style="text-align:left;">
                <p><span class="rule-tag">●APシステム:</span> 毎ターン最大APが1増加（最大10）。維持費が最大APから引かれた分が使用可能APになる。</p>
                <p><span class="rule-tag">●勝利条件:</span> 計測スコアを溜め、「勝利カード」（10点 or 30点）を使用せよ！</p>
                <p><span class="rule-tag">●カードタイプ:</span> MACHINE（機材）、STAFF（社員）、SPELL（測量作業）の3種類。全55種のカード効果を駆使せよ！</p>
                <p><span class="rule-tag">●天候システム:</span> 豪雨（スペル禁止）、濃霧（計測値半減）、晴天。ドローンは霧に強い。</p>
                <p><span class="rule-tag">●進化システム:</span> 下位機種が場にいれば、上位機種をコスト1で重ねて出せる！（GPS→RTK-GPS、TS→トータルステーション→トータルステーションULTIMATE）</p>
                <p><span class="rule-tag">●特殊状態:</span> frozen（凍結）：指定ターン数の間、攻撃・効果・維持費が無効化される。ターン開始時に1ずつ減少。</p>
                <p><span class="rule-tag">●選択システム:</span> Training（研修）、Lost（迷子）、Bush（藪漕ぎ）、Boundary（境界石）などは対象カード・プレイヤーを選択して効果発動。</p>
                <p><span class="rule-tag">●Rush効果:</span> タグ"Rush"持ちのカードは相手ターン終了時に破壊される短期戦力。</p>
                <p><span class="rule-tag">●戦略のコツ:</span> 序盤は安価な社員・機材で展開、中盤で計測値を稼ぎ、終盤に勝利カードで決着！維持費管理が勝敗を分ける。</p>
            </div>
        </div>

        <div id="room-section" style="margin-top:40px; background:rgba(20, 30, 48, 0.9); padding:25px; border-radius:15px; max-width:500px; border:2px solid rgba(241, 196, 15, 0.4);">
            <h3 style="color:var(--gold); margin-top:0;">ルーム選択</h3>
            <div style="display:flex; gap:15px; margin-bottom:20px;">
                <button onclick="createRoom()" class="btn" style="background:var(--green); color:#fff; font-size:18px; flex:1;">ルームを作成</button>
            </div>
            <div style="display:flex; gap:10px;">
                <input id="room-input" type="text" placeholder="4桁のルーム番号" maxlength="4" style="flex:1; padding:12px; font-size:16px; border-radius:8px; border:2px solid #444; background:#222; color:#fff; text-align:center;">
                <button onclick="joinRoomByInput()" class="btn" style="background:var(--cyan); color:#fff; font-size:18px;">参加</button>
            </div>
            <div id="room-status" style="margin-top:15px; text-align:center; color:var(--gold); font-size:14px; min-height:24px;"></div>
        </div>
    </div>

    <div id="screen-waiting" style="display:none; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
        <h1 style="color:var(--gold); font-size:48px; text-shadow: 0 0 20px var(--gold); margin:0;">参加者待機中...</h1>
        <div style="margin-top:30px; background:rgba(20, 30, 48, 0.9); padding:30px; border-radius:15px; border:2px solid rgba(241, 196, 15, 0.4);">
            <p style="font-size:24px; color:#fff;">ルーム番号</p>
            <p id="waiting-room-number" style="font-size:64px; color:var(--gold); font-weight:bold; letter-spacing:10px; margin:20px 0;">----</p>
            <p style="font-size:18px; color:#aaa;">この番号を相手に伝えてください</p>
            <div style="margin-top:30px; padding:20px; background:rgba(52, 152, 219, 0.1); border-radius:10px; border:1px solid rgba(52, 152, 219, 0.3);">
                <p style="color:var(--cyan); font-size:16px; margin:5px 0;">あなたは <span style="font-weight:bold; font-size:20px;">P1: 工事部長</span> です</p>
            </div>
        </div>
        <div class="loading-spinner" style="margin-top:40px;">
            <div style="width:60px; height:60px; border:6px solid rgba(241, 196, 15, 0.2); border-top:6px solid var(--gold); border-radius:50%; animation:spin 1s linear infinite;"></div>
        </div>
    </div>

    <div id="screen-deck" style="display:none; padding:20px; height:100vh; box-sizing:border-box;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="color:var(--gold); margin:0;">デッキ編成 (<span id="deck-count">0</span>/40)</h2>
            <div style="display:flex; gap:15px;">
                <button onclick="loadDeck('TRAINING')" class="btn" style="background:#333; color:#fff;">社員育成デッキ</button>
                <button onclick="loadDeck('SURVEY')" class="btn" style="background:#333; color:#fff;">測量機械デッキ</button>
                <button onclick="loadDeck('CONSTRUCTION')" class="btn" style="background:#333; color:#fff;">重機土木デッキ</button>
                <button onclick="submitDeck()" class="btn btn-gold">現場へ出撃！</button>
            </div>
        </div>
        <div id="deck-grid" style="display:grid; grid-template-columns:repeat(9, 1fr); gap:10px; height:80vh; overflow-y:auto; background:rgba(0,0,0,0.3); padding:15px; border-radius:10px;"></div>
    </div>

    <div id="screen-battle">
        <div id="turn-indicator" style="grid-column:1/-1; text-align:center; padding:10px; font-weight:bold; letter-spacing:10px; background:#222;">WAITING...</div>
        <div style="display:flex; flex-direction:column; justify-content:space-between; height:calc(100vh - 45px);">
            <div id="opp-field" class="field"></div>
            <div id="my-field" class="field"></div>
            <div id="my-hand" style="display:flex; justify-content:center; gap:8px; padding:20px; background:rgba(0,0,0,0.6); min-height:170px;"></div>
        </div>
        <div class="sidebar">
            <div id="room-display" style="font-size:14px; color:var(--gold); margin-bottom:10px; text-align:center; background:rgba(20, 30, 48, 0.8); padding:8px; border-radius:8px; border:1px solid rgba(241, 196, 15, 0.3);">ルーム: <span id="current-room">----</span></div>
            <div style="font-size:18px; color:#aaa;">Day <span id="turn-txt" style="color:#fff;">1</span> / 天候: <span id="weather-txt" style="color:var(--gold);">晴天</span></div>
            <div style="background:#222; padding:15px; border-radius:10px; border:1px solid #444; text-align:center;">
                <div style="font-size:12px; color:#888;">現在の計測スコア</div>
                <div id="my-score" style="font-size:48px; color:var(--gold); font-weight:bold;">0</div>
                <hr style="border:0; border-top:1px solid #444; margin:10px 0;">
                <div style="font-size:12px; color:#888;">残りAP / 最大AP</div>
                <div id="my-ap" style="font-size:28px; color:#2ecc71;">2/2</div>
            </div>
            <div id="log" class="log"></div>
            <button onclick="socket.emit('end_turn',{player_id:myId})" class="btn btn-gold" style="width:100%; font-size:20px;">ターン終了</button>
        </div>
    </div>

    <script>
        const socket = io();
        let myId, myDeck = [];
        let lastTurn = null;
        let currentRoomId = null;

        // ルーム作成
        function createRoom() {
            socket.emit('create_room');
        }

        // ルーム参加（入力から）
        function joinRoomByInput() {
            const roomId = document.getElementById('room-input').value.trim();
            if (roomId.length !== 4) {
                document.getElementById('room-status').textContent = '4桁のルーム番号を入力してください';
                return;
            }
            socket.emit('join_room', { room_id: roomId });
        }

        // ルーム作成成功
        socket.on('room_created', (data) => {
            currentRoomId = data.room_id;
            myId = data.player_id;  // P1として自動割り当て
            document.getElementById('screen-title').style.display = 'none';
            document.getElementById('screen-waiting').style.display = 'flex';
            document.getElementById('waiting-room-number').textContent = currentRoomId;
        });

        // ルーム参加成功
        socket.on('room_joined', (data) => {
            currentRoomId = data.room_id;
            myId = data.player_id;  // P2として自動割り当て
            // P2は待機せず直接デッキ編成へ（room_readyで遷移）
        });

        // 2人揃った通知
        socket.on('room_ready', (data) => {
            document.getElementById('screen-title').style.display = 'none';
            document.getElementById('screen-waiting').style.display = 'none';
            document.getElementById('screen-deck').style.display = 'block';
            renderDeckGrid();
        });

        // エラー処理
        socket.on('error', (data) => {
            document.getElementById('room-status').textContent = data.message;
        });

        // Pixabay APIで現場風の実写背景を取得（無料、APIキー不要）
        const bgUrls = [
            'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=1920&h=1080&fit=crop', // 工事現場
            'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=1920&h=1080&fit=crop', // 山道
            'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=1920&h=1080&fit=crop'  // 都市道路
        ];
        const randomUrl = bgUrls[Math.floor(Math.random() * bgUrls.length)];
        
        // 背景画像を設定
        const bgElement = document.querySelector('.master-bg');
        bgElement.style.backgroundImage = `url('${randomUrl}')`;
        bgElement.style.opacity = '1';
        console.log(`現場背景読込: ${randomUrl}`);

        // クライアント側マスターデータの修正（サーバー側と文言を合わせる）
        const MASTER_CARDS = [
            {id:"Newbie", name:"新入社員", cost:1, power:1, upkeep:0, type:"MACHINE", desc:"1枚引く"},
            {id:"Staff", name:"担当社員", cost:3, power:4, upkeep:1, type:"MACHINE", desc:"進化(1)"},
            {id:"Chief", name:"主任技術者", cost:5, power:8, upkeep:0, type:"MACHINE", desc:"進化(1)維持0"},
            {id:"Senior", name:"教育係", cost:2, power:3, upkeep:1, type:"MACHINE", desc:"新入パ+3"},
            {id:"Ace", name:"エース", cost:4, power:12, upkeep:2, type:"MACHINE", desc:"高出力"},
            {id:"Leader", name:"現場代理人", cost:6, power:15, upkeep:1, type:"MACHINE", desc:"高効率"},
            {id:"Expert", name:"職人", cost:5, power:10, upkeep:2, type:"MACHINE", desc:"安定計測"},
            {id:"Clerk", name:"事務員", cost:2, power:1, upkeep:0, type:"MACHINE", desc:"毎AP+1"},
            {id:"Intern", name:"実習生", cost:0, power:0, upkeep:0, type:"MACHINE", desc:"コスト0"},
            {id:"SafetyOfficer", name:"安全員", cost:3, power:2, upkeep:1, type:"MACHINE", desc:"防衛"},
            {id:"LevelBasic", name:"普通レベル", cost:1, power:2, upkeep:1, type:"MACHINE", desc:"基本"},
            {id:"LevelAuto", name:"オートレベル", cost:3, power:6, upkeep:1, type:"MACHINE", desc:"進化(1)"},
            {id:"StaffBasic", name:"アルミS", cost:1, power:2, upkeep:1, type:"MACHINE", desc:"基本"},
            {id:"StaffRef", name:"反射S", cost:3, power:7, upkeep:1, type:"MACHINE", desc:"進化(1)"},
            {id:"TS", name:"光波TS", cost:4, power:10, upkeep:2, type:"MACHINE", desc:"主力"},
            {id:"GNSS", name:"GNSS", cost:6, power:18, upkeep:3, type:"MACHINE", desc:"晴天+5"},
            {id:"Drone", name:"ドローン", cost:5, power:14, upkeep:2, type:"MACHINE", desc:"霧無効"},
            {id:"Scanner", name:"3Dスキャナ", cost:8, power:25, upkeep:3, type:"MACHINE", desc:"最強出力"},
            {id:"UsedTS", name:"中古TS", cost:2, power:12, upkeep:2, type:"MACHINE", desc:"高維持費"},
            {id:"Laser", name:"レーザー", cost:2, power:5, upkeep:1, type:"MACHINE", desc:"室内"},
            {id:"Compass", name:"磁石", cost:1, power:1, upkeep:0, type:"MACHINE", desc:"方位"},
            {id:"Tripod", name:"三脚", cost:1, power:1, upkeep:0, type:"MACHINE", desc:"基本"},
            {id:"Caliper", name:"ノギス", cost:1, power:2, upkeep:1, type:"MACHINE", desc:"精密"},
            {id:"Scale", name:"スケール", cost:1, power:1, upkeep:0, type:"MACHINE", desc:"基本"},
            {id:"Chalk", name:"チョーク", cost:1, power:1, upkeep:0, type:"MACHINE", desc:"印"},
            {id:"Excavator", name:"重機", cost:7, power:20, upkeep:4, type:"MACHINE", desc:"強力"},
            {id:"Rental", name:"レンタル", cost:3, power:15, upkeep:5, type:"MACHINE", desc:"一時的"},
            {id:"SmallTruck", name:"軽トラ", cost:2, power:1, upkeep:0, type:"MACHINE", desc:"設置安"},
            {id:"Concrete", name:"生コン", cost:5, power:10, upkeep:3, type:"MACHINE", desc:"雨-5"},
            {id:"Pump", name:"ポンプ", cost:3, power:0, upkeep:1, type:"MACHINE", desc:"雨無効"},
            {id:"GenSet", name:"発電機", cost:3, power:3, upkeep:1, type:"MACHINE", desc:"全体+2"},
            {id:"Radio", name:"無線機", cost:2, power:2, upkeep:1, type:"MACHINE", desc:"空強化"},
            {id:"Lights", name:"投光器", cost:3, power:4, upkeep:1, type:"MACHINE", desc:"後半強"},
            {id:"Helmet", name:"メット", cost:1, power:0, upkeep:0, type:"MACHINE", desc:"社員-1"},
            {id:"Barrier", name:"看板", cost:2, power:0, upkeep:1, type:"MACHINE", desc:"妨害"},
            {id:"Elite", name:"少数精鋭", cost:2, power:0, upkeep:0, type:"SPELL", desc:"2枚引"},
            {id:"Decision", name:"決断", cost:0, power:0, upkeep:0, type:"SPELL", desc:"AP最大+2"},
            {id:"Fund", name:"資金調達", cost:4, power:0, upkeep:0, type:"SPELL", desc:"AP最大+1"},
            {id:"Transceiver", name:"社員呼出", cost:1, power:0, upkeep:0, type:"SPELL", desc:"1枚引"},
            {id:"Safety", name:"安全巡回", cost:3, power:0, upkeep:0, type:"SPELL", desc:"敵AP減"},
            {id:"Lost", name:"紛失", cost:3, power:0, upkeep:0, type:"SPELL", desc:"破壊"},
            {id:"Note", name:"野帳", cost:1, power:0, upkeep:0, type:"SPELL", desc:"2枚引"},
            {id:"Repair", name:"修理", cost:2, power:0, upkeep:0, type:"SPELL", desc:"AP5回復"},
            {id:"Check", name:"Wチェック", cost:2, power:0, upkeep:0, type:"SPELL", desc:"3枚引"},
            {id:"Bush", name:"藪払い", cost:2, power:0, upkeep:0, type:"SPELL", desc:"小粒破壊"},
            {id:"Rush", name:"突貫", cost:0, power:0, upkeep:0, type:"SPELL", desc:"AP+4/壊"},
            {id:"Consult", name:"予報", cost:1, power:0, upkeep:0, type:"SPELL", desc:"晴天"},
            {id:"Training", name:"手当", cost:2, power:0, upkeep:0, type:"SPELL", desc:"社員強化"},
            {id:"NightWork", name:"徹夜", cost:0, power:0, upkeep:0, type:"SPELL", desc:"AP全快"},
            {id:"Complaint", name:"苦情", cost:3, power:0, upkeep:0, type:"SPELL", desc:"相手AP減"},
            {id:"Boundary", name:"境界", cost:2, power:0, upkeep:0, type:"SPELL", desc:"停止"},
            {id:"Overtime", name:"残業", cost:0, power:0, upkeep:0, type:"SPELL", desc:"引/AP+"},
            {id:"Audit", name:"監査", cost:4, power:0, upkeep:0, type:"SPELL", desc:"最大AP減"},
            {id:"Goal30", name:"工期完遂", cost:4, power:0, upkeep:0, type:"GOAL", desc:"30で勝利"},
            {id:"GoalFinal", name:"社長決裁", cost:10, power:0, upkeep:0, type:"GOAL", desc:"10で勝利"}
        ];

        function init(id) {
            myId = id;
            document.getElementById('screen-title').style.display = 'none';
            document.getElementById('screen-deck').style.display = 'block';
            renderDeckGrid();
        }

        function addCard(cardId, event) {
            if (event) event.stopPropagation();
            const count = myDeck.filter(id => id === cardId).length;
            if (count >= 4) {
                return; // 4枚制限
            }
            if (myDeck.length >= 40) {
                alert("デッキは最大40枚です！");
                return;
            }
            myDeck.push(cardId);
            document.getElementById('deck-count').innerText = myDeck.length;
            renderDeckGrid();
        }

        function removeCard(cardId, event) {
            if (event) event.stopPropagation();
            const idx = myDeck.indexOf(cardId);
            if (idx !== -1) {
                myDeck.splice(idx, 1);
                document.getElementById('deck-count').innerText = myDeck.length;
                renderDeckGrid();
            }
        }

        function renderDeckGrid() {
            const grid = document.getElementById('deck-grid');
            grid.innerHTML = "";
            MASTER_CARDS.forEach(c => {
                const currentCount = myDeck.filter(id => id === c.id).length;
                const d = document.createElement('div');
                d.className = `card ${c.type}`;
                
                // デッキに入っているカードは光らせる
                if (currentCount > 0) {
                    d.classList.add('in-deck');
                }
                
                d.style.position = 'relative';
                d.innerHTML = `
                    <div class="cost">${c.cost}</div>
                    <b>${c.name}</b><br><small>${c.desc}</small>
                    <div class="upkeep">維持:${c.upkeep}</div>
                    <div class="power">${c.power || ''}</div>
                    <div class="deck-badge">${currentCount}</div>
                    <div style="position:absolute; bottom:5px; left:0; right:0; display:flex; gap:5px; justify-content:center;">
                        <button onclick="removeCard('${c.id}', event)" class="deck-btn" style="background:#e74c3c; width:35px; height:30px; border:none; border-radius:5px; color:#fff; font-size:18px; cursor:pointer; font-weight:bold;">−</button>
                        <button onclick="addCard('${c.id}', event)" class="deck-btn" style="background:#27ae60; width:35px; height:30px; border:none; border-radius:5px; color:#fff; font-size:18px; cursor:pointer; font-weight:bold;">＋</button>
                    </div>
                `;
                
                // カード全体クリックで追加（従来の機能も維持）
                d.onclick = (e) => {
                    if (!e.target.classList.contains('deck-btn') && e.target.tagName !== 'BUTTON') {
                        addCard(c.id);
                    }
                };
                grid.appendChild(d);
            });
        }

        function loadDeck(mode) {
            const presets = {
                // 社員育成デッキ：社員カードとTraining（研修）で強化していく戦略
                TRAINING: [
                    "Newbie","Newbie","Newbie","Newbie",  // 新入社員を大量投入
                    "Staff","Staff","Staff",  // 進化先
                    "Chief","Chief",  // 最終進化
                    "Senior","Senior","Senior",  // 新入社員を強化
                    "Ace","Ace",  // 現場のエース
                    "Expert","Expert",  // ベテラン職人
                    "Clerk","Clerk","Clerk",  // 事務員でAP回復
                    "SafetyOfficer","SafetyOfficer",  // 安全管理
                    "Training","Training","Training",  // 研修で社員強化
                    "Elite","Elite",  // 少数精鋭
                    "Note","Note","Check",  // ドロー
                    "Repair","Repair","Overtime",  // AP管理
                    "Decision","Fund",  // 最大AP増加
                    "Helmet","Helmet",  // 安全装備
                    "Lost","Bush",  // 除去
                    "Goal30","Goal30","GoalFinal"  // 勝利条件
                ],
                
                // 測量機械デッキ：測量機器の進化ラインを活かす正統派
                SURVEY: [
                    "LevelBasic","LevelBasic","LevelBasic",  // レベル基本
                    "LevelAuto","LevelAuto","LevelAuto",  // オートレベル進化
                    "StaffBasic","StaffBasic","StaffBasic",  // スタッフ基本
                    "StaffRef","StaffRef","StaffRef",  // 反射スタッフ進化
                    "TS","TS","TS","TS",  // 光波トータルステーション
                    "Drone","Drone","Drone",  // ドローン（霧に強い）
                    "Laser","Laser",  // レーザー墨出し
                    "Compass","Tripod","Tripod",  // 補助機材
                    "GenSet","GenSet",  // 発電機で全体強化
                    "SmallTruck","SmallTruck",  // 軽トラで設置サポート
                    "Note","Note","Check","Check",  // ドロー
                    "Repair","Repair","Overtime",  // AP管理
                    "Consult","Consult",  // 天候操作
                    "Lost","Boundary",  // 除去・凍結
                    "Goal30","Goal30","GoalFinal"  // 勝利条件
                ],
                
                // 重機土木デッキ：大型重機とパワーで圧倒する
                CONSTRUCTION: [
                    "Excavator","Excavator","Excavator",  // バックホー
                    "Rental","Rental","Rental",  // レンタル重機
                    "Concrete","Concrete","Concrete",  // 生コン車
                    "Pump","Pump",  // 排水ポンプ（雨対策）
                    "GNSS","GNSS",  // GNSS衛星
                    "Scanner","Scanner",  // 3Dスキャナ
                    "UsedTS","UsedTS",  // 中古TS
                    "GenSet","GenSet",  // 発電機
                    "Lights","Lights",  // 投光器
                    "Intern","Intern","Intern",  // 実習生（囮）
                    "Clerk","Clerk",  // 事務員（AP回復）
                    "Rush","Rush",  // 突貫工事
                    "Note","Note","Elite",  // ドロー
                    "NightWork","Repair","Repair","Overtime","Overtime",  // AP大量管理
                    "Decision","Decision",  // 最大AP増加
                    "Lost","Safety",  // 除去・妨害
                    "Goal30","Goal30","GoalFinal"  // 勝利条件
                ]
            };
            myDeck = [...presets[mode]];
            document.getElementById('deck-count').innerText = myDeck.length;
            renderDeckGrid();
        }

        function submitDeck() {
            if(myDeck.length < 40) return alert("40枚選んでください！");
            socket.emit('submit_deck', {player_id: myId, deck: myDeck});
            document.getElementById('screen-deck').style.display = 'none';
            document.getElementById('screen-battle').style.display = 'grid';
        }

        function backToTitle() {
            socket.emit('reset_game');
            setTimeout(() => { location.reload(); }, 100);
        }
        
        function selectTarget(idx) {
            socket.emit('select_target', {player_id: myId, target_index: idx});
        }

        socket.on('update_ui', s => {
            // ルーム番号を表示
            if (currentRoomId) {
                document.getElementById('current-room').textContent = currentRoomId;
            }
            
            const me = s.players[myId], opp = s.players[myId==='p1'?'p2':'p1'];
            const ind = document.getElementById('turn-indicator');
            
            ind.innerText = s.turn === myId ? "YOUR TURN" : "ENEMY TURN";
            ind.style.color = s.turn === myId ? "var(--blue)" : "var(--red)";

            // 修正：ターン演出に天候を追加
            if (lastTurn && lastTurn !== s.turn) {
                const ov = document.getElementById('turn-overlay');
                const txt = document.getElementById('turn-overlay-text');
                txt.innerHTML = `Day ${s.turn_count} <br> PLAYER ${s.turn === 'p1' ? '1' : '2'} <br> <div style="font-size:40px; margin-top:10px;">${s.weather}</div>`;
                ov.style.display = 'flex';
                setTimeout(() => { ov.style.display = 'none'; }, 2000);
            }
            lastTurn = s.turn;

            document.getElementById('my-score').innerText = me.score;
            document.getElementById('my-ap').innerText = `${me.ap}/${me.max_ap}`;
            document.getElementById('weather-txt').innerText = s.weather;
            document.getElementById('turn-txt').innerText = s.turn_count;
            
            // 選択モード中かチェック
            const isSelectMode = s.pending_selection && s.pending_selection.player === myId;
            const selectType = isSelectMode ? s.pending_selection.type : null;
            const selectTargets = isSelectMode ? s.pending_selection.targets : [];
            
            const render = (c, i, isMe, canSelect) => {
                const selectClass = canSelect ? 'card-selectable' : '';
                const onclick = canSelect ? `selectTarget(${i})` : (isMe ? `socket.emit('play_card',{player_id:myId,card_index:${i}})` : '');
                const frozen = c.frozen || 0;
                return `
                    <div class="card ${c.type} ${selectClass}" onclick="${onclick}">
                        <div class="cost">${c.cost}</div><b>${c.name}</b><br><small>${c.desc}</small>
                        <div class="upkeep">維持:${c.upkeep||0}</div>
                        <div class="power">${c.power||''}</div>
                        ${frozen > 0 ? '<div style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(100,150,255,0.5);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;color:#fff;">凍結</div>' : ''}
                    </div>`;
            };
            
            // 選択UIの表示
            if (isSelectMode) {
                ind.innerText = "カードを選択してください";
                ind.style.color = "var(--gold)";
            }
            
            document.getElementById('my-hand').innerHTML = me.hand.map((c, i) => render(c, i, !isSelectMode, false)).join('');
            
            // 自分のフィールド（buff_ally, sacrifice系の選択対象）
            const myFieldSelectable = isSelectMode && ['buff_ally', 'sacrifice_for_upkeep', 'sacrifice_for_rush'].includes(selectType);
            document.getElementById('my-field').innerHTML = me.field.map((c, i) => 
                render(c, i, false, myFieldSelectable && selectTargets.includes(i))
            ).join('');
            
            // 相手のフィールド（destroy_enemy, freeze_enemy系の選択対象）
            const oppFieldSelectable = isSelectMode && ['destroy_enemy', 'freeze_enemy'].includes(selectType);
            document.getElementById('opp-field').innerHTML = opp.field.map((c, i) => 
                render(c, i, false, oppFieldSelectable && selectTargets.includes(i))
            ).join('');
            
            // ログの表示エリアを少し見やすく
            document.getElementById('log').innerHTML = s.log.slice(-12).map(l => `<div>> ${l}</div>`).join('');

            if(s.winner) {
                const modal = document.getElementById('result-modal');
                const title = document.getElementById('result-title');
                modal.style.display = 'flex';
                if (s.winner === myId) {
                    title.innerText = "観測完了！";
                    title.style.color = "var(--gold)";
                } else {
                    title.innerText = "観測失敗！";
                    title.style.color = "#888";
                }
            }
        });
    </script>
</body>
</html>

